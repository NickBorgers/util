# Docker Compose configuration for running smart-crop-video tests
#
# Quick Start:
#   docker-compose -f docker-compose.test.yml build          # Build test image
#   docker-compose -f docker-compose.test.yml run test-quick # Fast unit tests (~2s)
#   docker-compose -f docker-compose.test.yml run test-all   # All tests (~18min)
#
# Available Services:
#   test-quick       Fast unit tests only (286 tests)
#   test-unit        Unit tests with verbose output
#   test-integration Integration tests with FFmpeg (8 tests)
#   test-fast        Unit + integration + container + API (skip UI, ~8min)
#   test-all         All tests including Web UI (~18min)
#   test-shell       Interactive shell for debugging
#
# Custom test command:
#   docker-compose -f docker-compose.test.yml run tests pytest tests/test_api.py -v

version: '3.8'

services:
  # Base test service (shared configuration)
  tests:
    build:
      context: .
      dockerfile: tests/Dockerfile
    volumes:
      # Mount the entire smart-crop-video directory
      - .:/workspace
      # Mount Docker socket to allow tests to create containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount test cache for faster reruns
      - pytest-cache:/workspace/.pytest_cache
    working_dir: /workspace
    environment:
      # Ensure tests can communicate with Docker daemon
      - DOCKER_HOST=unix:///var/run/docker.sock
    # Run as root to access Docker socket (tests create containers)
    user: root
    # Default: run all tests
    command: pytest tests/ -v --tb=short

  # Quick unit tests (fastest option)
  test-quick:
    extends: tests
    command: pytest tests/unit/ -q

  # Unit tests with verbose output
  test-unit:
    extends: tests
    command: pytest tests/unit/ -v

  # Integration tests with FFmpeg
  test-integration:
    extends: tests
    command: pytest tests/integration/ -v

  # Fast tests (skip Web UI - ~8 minutes)
  test-fast:
    extends: tests
    command: pytest tests/ -m "not ui" -v --tb=short

  # All tests including Web UI (~18 minutes)
  test-all:
    extends: tests
    command: pytest tests/ -v --tb=short

  # Interactive shell for debugging
  test-shell:
    extends: tests
    command: /bin/bash
    stdin_open: true
    tty: true

volumes:
  pytest-cache:
