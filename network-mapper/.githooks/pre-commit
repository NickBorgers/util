#!/bin/bash

# Pre-commit hook that runs the same checks as CI pipeline using devcontainer
# This ensures code quality before commits reach the repository

set -e

echo "ğŸ”„ Running pre-commit checks using devcontainer..."

# Get the root directory of the git repository
REPO_ROOT=$(git rev-parse --show-toplevel)
NETWORK_MAPPER_DIR="$REPO_ROOT/network-mapper"

# Check if we're in the network-mapper directory or if changes affect network-mapper
if [[ "$PWD" == *"network-mapper"* ]] || git diff --cached --name-only | grep -q "^network-mapper/"; then
    echo "ğŸ“¦ Network-mapper changes detected, running checks..."

    # Change to network-mapper directory
    cd "$NETWORK_MAPPER_DIR"

    # Check if devcontainer is available
    if ! command -v devcontainer &> /dev/null; then
        echo "âŒ devcontainer CLI not found. Please install it:"
        echo "   npm install -g @devcontainers/cli"
        exit 1
    fi

    # Start devcontainer if not already running
    echo "ğŸš€ Starting devcontainer..."
    devcontainer up --workspace-folder . > /dev/null 2>&1

    # Function to run commands in devcontainer
    run_in_container() {
        devcontainer exec --workspace-folder . "$@"
    }

    echo "â¬‡ï¸  Downloading dependencies..."
    if ! run_in_container go mod download; then
        echo "âŒ Failed to download dependencies"
        exit 1
    fi

    echo "ğŸ” Verifying dependencies..."
    if ! run_in_container go mod verify; then
        echo "âŒ Failed to verify dependencies"
        exit 1
    fi

    echo "ğŸ§ª Running tests..."
    if ! run_in_container go test -v ./...; then
        echo "âŒ Tests failed"
        exit 1
    fi

    echo "ğŸ” Running go vet..."
    if ! run_in_container go vet ./...; then
        echo "âŒ go vet failed"
        exit 1
    fi

    echo "ğŸ“Š Installing and running staticcheck..."
    if ! run_in_container sh -c "go install honnef.co/go/tools/cmd/staticcheck@v0.4.7 && staticcheck ./..."; then
        echo "âŒ staticcheck failed"
        exit 1
    fi

    echo "ğŸ“ Checking code formatting..."
    UNFORMATTED=$(run_in_container gofmt -s -l .)
    if [ -n "$UNFORMATTED" ]; then
        echo "âŒ Code is not formatted properly. Please run:"
        echo "   devcontainer exec --workspace-folder . gofmt -s -w ."
        echo ""
        echo "Unformatted files:"
        echo "$UNFORMATTED"
        exit 1
    fi

    echo "âœ… All pre-commit checks passed!"
else
    echo "ğŸ“ No network-mapper changes detected, skipping checks"
fi

echo "ğŸ‰ Pre-commit hook completed successfully"